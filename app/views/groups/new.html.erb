<div class="container-fluid">
    <div class="row">
        <div class="col col-12">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="#">Dashboard</a>
                </li>
                <li class="breadcrumb-item active">Upload Documents</li>
            </ol>
            <div id="documents_form">
                <form class="new_upload_document new_document_form" id="new_upload_document" enctype="multipart/form-data" action="/save_group" accept-charset="UTF-8" method="post">
                    <input name="utf8" type="hidden" value="âœ“"><input type="hidden" name="authenticity_token" value="/lBy4wW+drsehD1P5YX+g9/EQJAkOSWWhh+jyLtzD6W3JdkjX7hB1jHh7MJBzV7nmEPqIA4Ltc6XOsnkh5oZjg==">
                    <div id="documents_wrap">
                        <div class="document">
                            <div class="col-sm-5 document_name_field">
                                <div>
                                    <input autofocus="autofocus" class="form-control" placeholder="Document Name" required="required" type="text" value="" name="upload_document[1][document_name]" id="upload_document_document_name">
                                </div>
                            </div>
                            <div class="col-sm-5" style="margin-bottom: 0px;">
                                <div>
                                    <input class="uploadDocument documentFileField" type="file" name="upload_document[1][document]" id="upload_document_document">
                                </div>
                            </div>
                            <!-- <i class="fas fa-times remove_form fa-2x col-sm-2" style="cursor:pointer;color:red;"></i> -->
                            <div class="error_message">dsadasdasdasdadsadsa</div>
                        </div>
                    </div>
                </form>
                <div id="history_list">
                </div>
            </div>
            <div id="action_button" style="margin-top: 2rem;">
                <%= button_tag "Upload", :class => 'btn_1', :id => 'upload_submit_button' %>
                <%= button_tag "Add More", :class => 'btn_1', :id => 'add_more_button' %>
                <%= button_tag "Add From History", :class => 'btn btn-primary', :id => 'add_more_from_history_button', :data => {:toggle => 'modal', :target => '#fromHistory'} %>
            </div>
        </div>
    </div>
    <div id="loader_wrap_main" class="loader_wrap" style="display: none;">
        <img src="/images/loader.gif" id="loader_img" width="100" height="100">
    </div>
</div>
<%= render "groups/partial/from_history_main" %>
<script>
$(document).ready(function() {
    $("#add_more_button").click(function() {
        var new_doc = $(".document").first().clone();
        var total_doc = $('#documents_form').find('.document').length

        var label_name_for = $(new_doc).find('label').attr('for') + (total_doc + 1).toString();
        var document_name = 'upload_document[' + (total_doc + 1).toString() +'][document_name]';
        var document_name_id = $(new_doc).find('#upload_document_document_name').attr('id') + (total_doc + 1).toString();
        var document_file_name = 'upload_document[' + (total_doc + 1).toString() +'][document]';
        $(new_doc).find('input[type=text]').attr('id', document_name_id);
        $(new_doc).find('input[type=text]').attr('name', document_name);
        $(new_doc).find('input[type=file]').attr('name', document_file_name);
        $(new_doc).find('label').attr('for', label_name_for);
        $('<i>').attr({ class: 'fas fa-times remove_form fa-2x col-sm-2', style: "cursor:pointer;color:red;" }).insertBefore(new_doc.find('.error_message'));
        $('#documents_wrap').append(new_doc);
    });

    $(document).on('click', '#upload_submit_button', function(e) {
        var total_count = $('.document').length;
        var success_count = 0;
        var count = 1;
        $('#loader_wrap_main').show();
        $(this).text('Please wait');
        $(this).attr('disabled', 'true');
        var check_if_valid = check_all_form_valid();
        if (check_if_valid == true) {
            var response = submitForm($('form'));
        }
        else {
            $('#loader_wrap_main').hide()
            $(this).text('Upload');
            $(this).removeAttr('disabled');
            notification("Please fill all entry.", "error")
        }
    });

    function submitForm(form) {
        var history_data = ""
        var valuesToSubmit = new FormData(form);
        if (group_id == "") {
            var document_ids = $('#history_list').find('.history_document').map(function() {
                return $(this).attr('id');
            }).get().join();
            valuesToSubmit.append('history_document_ids', document_ids);
        }
        $.ajax({
            type: "POST",
            url: $(form).attr('action'), //sumbits it to the given url of the form
            data: valuesToSubmit,
            processData: false,
            contentType: false,
            async: false,
            success: function(response) {
                res = response
            },
            error: function(error) {
                res = error
            }
        });
        return res;
    }
});

function check_all_form_valid() {
    var status = true;
    $('.new_upload_document').each(function(i, form) {
        if ($(form).find('input[type]:file').val() == '' || $(form).find('input[type]:text').val() == '') {
            status = false
        }
    });
    return status;
}

$(document).on('click', '.remove_form', function() {
    $(this).parent('form').remove();
});

$(document).on('click', '.remove_history_document', function() {
    $(this).parent('.history_document_wrapper').remove();
});
</script>