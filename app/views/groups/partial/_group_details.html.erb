<div class="card mb-3">
    <div class="card-header">
        <i class="fas fa-table"></i>
        Group Item: <span id="total_group_item">
            <%= @group.documents.length %></span></div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered document_table" id="dataTableGroupDoc" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th width="30%">Preview</th>
                        <th width="30%">Name</th>
                        <% if @group.is_group_sent_for_printing? %>
                        <th width="30%">Status</th>
                        <% else %>
                        <th width="30%">Action</th>
                        <% end %>
                    </tr>
                </thead>
                <tbody id="tbody_head" data-group-id="<%= @group.id.to_s %>">
                    <% @documents.each do |a| %>
                    <tr data-id="<%= a.id%>" class="document_record">
                        <td width="30%">
                            <% if get_file_type(a) == 'jpg' %>
                            <div class="item group_item2" data-src="<%= a.document_url%>">
                                <img class="preview" data-id="<%= a.id %>" src="<%= a.document_url%>" />
                            </div>
                            <% else %>
                            <% url = get_path_with_server_url(request.base_url,a) %>
                            <div class="item group_item2" data-iframe="true" data-src="https://docs.google.com/gview?url=<%= url %>&embedded=true">
                                <iframe src="https://docs.google.com/gview?url=<%= url %>&embedded=true"></iframe>
                            </div>
                            <% end %>
                        </td>
                        <td width="30%">
                            <%= a.document_name %>
                        </td>
                        <% if @group.is_group_sent_for_printing? %>
                        <td width="30%">
                            <%= a.status %>
                        </td>
                        <% else %>
                        <td width="30%">
                            <a class="remove_group_document" alt="remove" href="javscript:;"><i class="fas fa-trash"></i></a>
                        </td>
                        <% end %>
                    </tr>
                    <% end %>
                </tbody>
            </table>
        </div>
    </div>
    <% if @group.status != 'completed' and @group.status != 'failed' and @group.status != 'processing' %>
    <div class="card-footer small text-muted d-flex align-items-center">
        <%= button_tag "Proceed TO Payment", id: 'proceed_to_payment', class: 'btn btn-primary' %>
        <div class="dropdown" style="margin-left:10px;">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                Add More
            </button>
            <div class="dropdown-menu">
                <a class="dropdown-item btn btn-primary" href="#" data-toggle="modal" data-target="#fromDesktop">From Desktop</a>
                <a class="dropdown-item btn btn-primary" href="#" data-toggle="modal" data-target="#fromHistory">From History</a>
            </div>
        </div>
    </div>
    <% end %>
    <% if @documents.present? %>
    <div class="card-footer small text-muted">Updated at
        <%= @documents.first.updated_at.strftime("%d %B %Y , %l:%M %p") %>
    </div>
    <% end %>
    <%= render "groups/partial/from_desktop" %>
    <%= render "groups/partial/from_history" %>
</div>
<script type="text/javascript">
$(".remove_group_document").click(function() {
    var self = this;
    var document_id = [$(this).closest('.document_record').data('id')];
    var main_tr = $('tr.document_record[data-id="' + document_id[0] + '"]')
    var group_id = main_tr.parent().data('group-id')
    $(this).hide();

    function onSuccess(response) {
        $('#group_content').html(response);
    }

    function onError(reponse) {
        $(self).show();
    }

    removeFromGroup(group_id, document_id, onSuccess, onError);
});

function removeFromGroup(group_id, document_ids, successcb, errorcb) {
    $.ajax({
        type: "POST",
        beforeSend: setCsrfToken, // implemented in
        url: "/remove_document_from_group",
        data: { document_ids: document_ids, id: group_id },
        success: function(data) {
            if (successcb) successcb(data);
        },
        error: function(exception) {
            if (successcb) successcb(exception);
        }
    });
}
$(document).ready(function() {
    $('#dataTableGroupDoc').DataTable({
        "ordering": false
    });

    $('#tbody_head').lightGallery({
        selector: '.group_item2',
        iframeMaxWidth: '80%',
        thumbnail: false,
    });
});

$("#proceed_to_payment").click(function() {
    $.ajax({
        type: "POST",
        beforeSend: setCsrfToken, // implemented in application.html.erb
        url: "/test_whatsapp_twillio_api",
        data: { group_id: 'group_id' },
        success: function(data) {},
        error: function(exception) {
            // if (successcb) successcb(exception);
        }
    });
});
</script>
<script src="https://cdn.jsdelivr.net/picturefill/2.3.1/picturefill.min.js"></script>